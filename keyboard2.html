<!DOCTYPE html>
<html style="background-color: #c9cee9;">

<head>
  <link rel="icon"
    type="image/png"
    href="icon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
<title>edo Keyboard</title>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-43126621-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-43126621-2');
</script>
<script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
<link rel="stylesheet" type="text/css" href="style.css"/>
<link rel="stylesheet" type="text/css" href="edo_style.css"/>
</head>

<body>
    <div class="deeper">
    <h1><a href="index.html" title="Get me out of here!">Richard Hughes</a></h1>
    <h2 style="padding-top: 0px;">Equal Divisons of the Octave Keyboard [alpha]</h2>
    </div>
    <ul>
      <li>making a tone.js microtonal keyboard...</li>
    </ul>

    <!-- <button value='button' name='button'>start</button> -->

    <div style="position: relative; text-align: center;">
        <form  name="edo-cal">
          <p><i> f</i><sub>0</sub> (Hz) &nbsp
            <input name="f0" id="f0" type="text" placeholder="e.g 440" size="10" required><br>
            divisions
            <input name="divisions" type="text" placeholder="max: 36" size="10" required><br>
            <br>
            <button type="submit" value="Submit">Submit</button>
          </p>
        </form>
    </div>

    <div class='field'>
      <span class='select'>
        <select id='oscillator-type'>
          <option value='sine'>sine</option>
          <option value='triangle'>triangle</option>
          <option value='sawtooth'>sawtooth</option>
          <option value='square'>square</option>
          <option value='pulse'>pulse</option>
        </select>
      </span>
    </div>

    <div class="field">
        <label class="label" for="envelope-attack">Attack <span></span></label>
        <div class="control">
          <input id="envelope-attack" class="input is-fullwidth"
                 value="1" min="0" max="10" step="1" type="range" />
    </div>

    <div class="field">
        <label class="label" for="envelope-release">Release <span></span></label>
        <div class="control">
          <input id="envelope-release" class="input is-fullwidth"
                 value="7" min="0" max="10" step="1" type="range" />
        </div>
    </div>

    <div id='container'></div>

    <div id="edo"></div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbzkqewD0LJBSTTDvPNkmHf_-ORkd1Gd_g8dDXAyf9nOCmz-rGIs654vr_3mFV_vIc50/exec'
const form = document.forms['edo-cal']

    //get info from excel
    form.addEventListener('submit', e => {
    e.preventDefault()
    fetch(scriptURL, { method: 'POST', body: new FormData(form)})
    .then(response => {
        console.log('Success!', response);
        response.body.getReader().read().then(function processText({ done, value }) {
          // console.log(value)
          const result = new TextDecoder("utf-8").decode(value)
          const object = JSON.parse(result)

          fillTable(object.result)

          frequencies = object.result.slice(1).map(row => Number(row[0]))
        })
        form.reset();
        // alert("Sent!");
    })
    .catch(error => console.error('Error!', error.message))
})
      
        // function fillTable(tableResult) {
        //   document.getElementById("edo").innerHTML =
        //     "<table border=\"1\">"
        //     + tableResult.map(r =>
        //       "<tr>" + r.map(c => `<td>${c}</td>`).join("\n") + "</tr>"
        //     ).join("\n") + "</table>"
        // }

//tone.js synth
class Instrument{
  constructor() {
    // this.synth = new Tone.FMSynth({
    //     oscillator: {
    //         type: 'triangle'
    //     },
    //     modulationIndex: 10,
    //     modulation: {
    //         type: 'sawtooth'
    //     },
    //     envelope: {
    //         attack: 3,
    //         decay: 3,
    //         sustain: .8,
    //         release: 8,
    //         attackCurve: 'sine'
    //     }
    // });
    this.synth = null;
    this.inmix = new Tone.Gain(0.6);
    this.outmix = new Tone.Gain(0.6);
    this.lowp = new Tone.Filter(20000, "lowpass");
    this.reverb = new Tone.Reverb({
      wet: .6,
      decay: 30,
    });
    //inmix => distortion => lowpass filter => reverb => outmix
    // this.synth.connect(inmix);
    this.inmix.connect(this.lowp);
    this.lowp.connect(this.reverb);
    this.reverb.connect(this.outmix);
    this.outmix.toDestination();
  }

 update(oscillatorType, envelope) {
     this._updateSynthType(envelope);
     this._updateOscillatorType(oscillatorType);
  }
  
  _updateSynthType(envelope) {
    // If we have already defined the synth
    if (this.synth) {
      this.synth.disconnect(this.inmix);
      this.synth.dispose();
    }
    // The new Synth!
    let settings = this.defaultSettings.FMSynth || {};
    settings.envelope = Object.assign(settings.envelope, envelope);
    this.synth = new Tone.FMSynth(settings);
    this.synth.connect(this.inmix);
  }
  
  _updateOscillatorType(oscillatorType) {
    // let partials = oscillatorPartials === 'none' ? '' : oscillatorPartials;
    this.synth.oscillator.type = `${oscillatorType}`;
  }
  get defaultSettings() {
    return {
        FMSynth: {
            oscillator: {
                type: 'triangle'
            },
            modulationIndex: 10,
            modulation: {
                type: 'sawtooth'
            },
            envelope: {
                attack: 3,
                decay: 3,
                sustain: .7,
                release: 8,
                attackCurve: 'sine'
            }
        }
     };
  }
}
// let $octave = document.querySelector("#octave");
// let $synthType = document.querySelector("#synth-type");
let $oscillatorType = document.querySelector("#oscillator-type");
// let $oscillatorPartials = document.querySelector("#oscillator-partials");
// let $toggle = document.querySelector('#toggle');
let $envelopeAttack = document.querySelector('#envelope-attack');
// let $envelopeDecay = document.querySelector('#envelope-decay');
// let $envelopeSustain = document.querySelector('#envelope-sustain');
let $envelopeRelease = document.querySelector('#envelope-release');
let inst = new Instrument();

let steps = [0, 0.001, 0.005, 0.01, 0.05, 0.1, 0.125, 0.25, 0.5, 0.75, 1];

$envelopeAttack.addEventListener('change', update);
// $envelopeDecay.addEventListener('change', update);
// $envelopeSustain.addEventListener('change', update);
$envelopeRelease.addEventListener('change', update);

// $toggle.addEventListener('click', e => {
//   inst.toggle();
//   if ($toggle.className.match('is-success')) {
//     $toggle.classList.remove('is-success');
//     $toggle.classList.add('is-danger');
//   } else {
//     $toggle.classList.add('is-success');
//     $toggle.classList.remove('is-danger');
//   }
//   $toggle.classList.toggle('active');
// });

update();

// $octave.addEventListener("change", () => inst.setNotes($octave.value));
// $synthType.addEventListener("change", update);
$oscillatorType.addEventListener("change", update);
// $oscillatorPartials.addEventListener("change", update);

function update() {
  let envelope = {
    attack: steps[parseInt($envelopeAttack.value)],
    // decay: steps[parseInt($envelopeDecay.value)],
    // sustain: steps[parseInt($envelopeSustain.value)],
    release: steps[parseInt($envelopeRelease.value)]
  };
  document.querySelector('label[for="envelope-attack"] span')
      .innerText = envelope.attack;
//   document.querySelector('label[for="envelope-decay"] span')
//       .innerText = envelope.decay;
//   document.querySelector('label[for="envelope-sustain"] span')
//       .innerText = envelope.sustain;
  document.querySelector('label[for="envelope-release"] span')
      .innerText = envelope.release;
  inst.update(
    // $synthType.value,
    $oscillatorType.value,
    // $oscillatorPartials.value,
    envelope
  );
}

var notes = [210, 220, 233, 248]

var html = '';
for (var i = 0; i < notes.length; i++) {
  var note = notes[i];
  html += `<div class='note' onmousedown='noteDown(this)' 
  onmouseup='noteUp(this, false)' onmouseleave='noteUp(this, false)'
  data-note='${note}'></div>`;
}

document.getElementById('container').innerHTML= html;

document.querySelector("button")?.addEventListener("click", async () => {
  await start();
});

function noteDown(elem) {
  var note = elem.dataset.note;
  if (this.synth) this.synth.triggerAttack(note);
  elem.style.background = 'red'
}

function noteUp(elem) {
  if (this.synth) this.synth.triggerRelease();
  elem.style.background = 'orangered'
}

//MIDI

class MIDIAccess{
    constructor(args = {}) {
        this.onDeviceInput = args.onDeviceInput || console.log;
    }

    start() {
       return new Promise((resolve, reject) => {
        this._requestAccess().then(access => {
            this.initalize(access);
            resolve();
        }).catch(() => reject('Something went wrong.'));
       });     
    }

    initalize(access) {
        const devices = access.inputs.values();
        for (let device of devices)
            this.initalizeDevice(device);
    }

    initalizeDevice(device) {
        device.onmidimessage = this.onMessage.bind(this);
    }

    onMessage(message) {
        let [_, input, value] = message.data;
        this.onDeviceInput({ input, value });
        // console.log({ input, value });
    }

    _requestAccess() {
        return new Promise((resolve, reject) => {
            if (navigator.requestMIDIAccess)
                navigator.requestMIDIAccess()
                .then(resolve)
                .catch(reject);
            else reject();
        });
    }
}

const midi = new MIDIAccess({ onDeviceInput });
midi.start().then(() => {
    console.log('Started!');
}).catch(console.error);

function onDeviceInput({ input, value }) {
    console.log('onDeviceInput!', input, value);
}

// document.querySelector("button")?.addEventListener("mousedown", async () => {
//   synth.triggerAttack(note);
// });

// document.querySelector("button")?.addEventListener("mouseup", async () => {
//   synth.triggerRelease();
// });
</script>